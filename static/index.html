<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>首都师范大学在校生生存助手</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f0f;
            --bg-2: #141414;
            --panel: #1a1a1a;
            --panel-2: #202020;
            --panel-3: #272727;
            --border: rgba(255, 255, 255, 0.08);
            --text: #e5e7eb;
            --muted: #a1a1aa;
            --accent: #10a37f;
            --accent-2: #4ade80;
            --danger: #ef4444;
            --shadow: 0 30px 60px rgba(0, 0, 0, 0.45);
            --radius-lg: 18px;
            --radius: 14px;
            --radius-sm: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: transparent;
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 999px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        body {
            min-height: 100vh;
            font-family: "IBM Plex Sans", "Space Grotesk", sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background:
                radial-gradient(circle at 20% 12%, rgba(16, 163, 127, 0.2), transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.15), transparent 42%),
                radial-gradient(circle at 50% 85%, rgba(16, 163, 127, 0.12), transparent 45%),
                linear-gradient(180deg, #0f0f0f 0%, #0b0b0b 100%);
            z-index: -2;
        }

        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background-image: repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.04) 0, rgba(255, 255, 255, 0.04) 1px, transparent 1px, transparent 14px);
            opacity: 0.2;
            z-index: -1;
            pointer-events: none;
        }

        .app {
            min-height: 100vh;
            display: grid;
            grid-template-columns: 300px 1fr;
        }

        .sidebar {
            background: var(--panel);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: #0b0b0b;
            font-weight: 700;
            font-family: "Space Grotesk", sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 1px;
        }

        .app-name {
            font-size: 16px;
            font-weight: 600;
        }

        .app-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px;
        }

        .btn {
            border: 1px solid var(--border);
            background: var(--panel-2);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .btn:hover {
            background: var(--panel-3);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .btn.primary {
            background: linear-gradient(135deg, rgba(16, 163, 127, 0.95), rgba(74, 222, 128, 0.9));
            border: none;
            color: #0a0a0a;
            font-weight: 600;
        }

        .btn.primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.ghost {
            background: transparent;
        }

        .btn.full {
            width: 100%;
        }

        .sidebar-section {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-section h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field label {
            font-size: 12px;
            color: var(--muted);
        }

        .field input {
            background: var(--panel-3);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        .field input:focus {
            outline: none;
            border-color: rgba(16, 163, 127, 0.5);
        }

        .toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--panel-3);
            font-size: 13px;
        }

        .toggle input {
            accent-color: var(--accent);
        }

        .status-hint {
            font-size: 12px;
            color: var(--muted);
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px dashed var(--border);
        }

        .memory-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .memory-item {
            padding: 10px;
            border-radius: 12px;
            background: #171717;
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .memory-meta {
            margin-top: 6px;
            font-size: 11px;
            color: var(--muted);
        }

        .memory-actions {
            display: flex;
            align-items: flex-start;
        }

        .icon-btn {
            border: none;
            background: rgba(16, 163, 127, 0.12);
            color: var(--accent-2);
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .icon-btn.danger {
            background: rgba(239, 68, 68, 0.16);
            color: #fecaca;
        }

        .main {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-header {
            height: 64px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            background: var(--bg-2);
        }

        .header-title {
            font-family: "Space Grotesk", sans-serif;
            font-size: 18px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
        }

        .messages {
            max-width: 820px;
            margin: 0 auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .empty-state {
            padding: 32px;
            border-radius: var(--radius-lg);
            border: 1px dashed var(--border);
            background: #121212;
            text-align: center;
        }

        .empty-state h2 {
            font-family: "Space Grotesk", sans-serif;
            font-size: 22px;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 18px;
        }

        .suggestions {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .suggestions button {
            border: 1px solid var(--border);
            background: #181818;
            color: var(--text);
            padding: 10px 12px;
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            font-size: 12px;
        }

        .message {
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: #1f1f1f;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
        }

        .message.user .avatar {
            background: rgba(16, 163, 127, 0.2);
            border-color: rgba(16, 163, 127, 0.4);
            color: var(--accent-2);
        }

        .message-body {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .message.user .message-header {
            justify-content: flex-end;
        }

        .bubble {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 14px;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message.user .bubble {
            background: rgba(16, 163, 127, 0.18);
            border-color: rgba(16, 163, 127, 0.35);
        }

        .message.pending .bubble {
            color: var(--muted);
        }

        .message.pending .bubble::after {
            content: "";
            display: inline-block;
            width: 6px;
            height: 6px;
            margin-left: 6px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 1.2s infinite;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .tag {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(16, 163, 127, 0.12);
            color: var(--accent-2);
            border: 1px solid rgba(16, 163, 127, 0.25);
        }

        .tag.intent {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.35);
            color: #bfdbfe;
        }

        .tag.warn {
            background: rgba(239, 68, 68, 0.16);
            border-color: rgba(239, 68, 68, 0.35);
            color: #fecaca;
        }

        .thinking {
            margin-top: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #121212;
            padding: 10px 12px;
        }

        .thinking summary {
            cursor: pointer;
            font-size: 12px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
        }

        .thinking summary::-webkit-details-marker {
            display: none;
        }

        .thinking summary::after {
            content: "▸";
            margin-left: auto;
            transition: transform 0.2s ease;
        }

        .thinking[open] summary::after {
            transform: rotate(90deg);
        }

        .think-status {
            font-size: 11px;
            color: var(--accent-2);
        }

        .thinking:not([open]) > :not(summary) {
            display: block;
        }

        .thinking:not([open]) .think-body {
            display: none;
        }

        .thinking[open] .think-placeholder {
            display: none;
        }

        .think-placeholder {
            margin-top: 8px;
            display: grid;
            gap: 6px;
        }

        .think-line {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 0.02em;
            animation: blink 1.8s infinite;
        }

        .think-body {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 12px;
            color: #d4d4d8;
        }

        .think-item {
            display: flex;
            gap: 8px;
        }

        .think-index {
            color: var(--accent-2);
            font-weight: 600;
        }

        .think-muted {
            color: var(--muted);
        }

        details.evidence {
            margin-top: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #131313;
            padding: 10px 12px;
        }

        details.evidence summary {
            cursor: pointer;
            font-size: 12px;
            color: var(--muted);
        }

        .evidence-list {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .evidence-item {
            padding: 8px 10px;
            border-radius: 10px;
            background: #1a1a1a;
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--text);
        }

        .memory-note {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(16, 163, 127, 0.12);
            border: 1px solid rgba(16, 163, 127, 0.3);
            font-size: 12px;
        }

        .memory-note ul {
            margin-left: 18px;
            margin-top: 6px;
            color: var(--text);
        }

        .composer {
            padding: 16px 24px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-2);
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .composer-inner {
            flex: 1;
            border-radius: var(--radius-lg);
            background: var(--panel-2);
            border: 1px solid var(--border);
            padding: 12px;
        }

        .composer-inner textarea {
            width: 100%;
            min-height: 48px;
            max-height: 160px;
            resize: none;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .composer-meta {
            margin-top: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: var(--muted);
        }

        .status-pill {
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(16, 163, 127, 0.2);
            color: var(--accent-2);
            border: 1px solid rgba(16, 163, 127, 0.35);
            font-size: 10px;
        }

        .status-pill.warn {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.35);
            color: #fecaca;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 30;
        }

        .toast-container {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }

        .toast {
            padding: 10px 14px;
            border-radius: 12px;
            background: #1f1f1f;
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--text);
            box-shadow: var(--shadow);
        }

        .toast.error {
            border-color: rgba(239, 68, 68, 0.45);
            color: #fecaca;
        }

        .mobile-only {
            display: none;
        }

        @media (max-width: 960px) {
            .app {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                transform: translateX(-100%);
                transition: transform 0.2s ease;
                z-index: 40;
            }

            body.sidebar-open .sidebar {
                transform: translateX(0);
            }

            body.sidebar-open .overlay {
                opacity: 1;
                pointer-events: auto;
            }

            .mobile-only {
                display: inline-flex;
            }

            .main-header {
                padding: 0 16px;
            }

            .messages {
                padding: 20px 16px;
            }

            .composer {
                padding: 12px 16px 20px;
                flex-direction: column;
                align-items: stretch;
            }

            .suggestions {
                grid-template-columns: 1fr;
            }
        }

        @keyframes blink {
            0%, 100% { opacity: 0.35; }
            50% { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
        }
    </style>
</head>
<body>
<div class="app">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">CNU</div>
            <div>
                <div class="app-name">在校生生存助手</div>
                <div class="app-sub">ChatGPT 风格黑夜界面</div>
            </div>
        </div>
        <button class="btn primary full" id="newChatBtn">新对话</button>

        <div class="sidebar-section">
            <h3>发送设置</h3>
            <label class="toggle">
                <span>增强版 RAG</span>
                <input type="checkbox" id="toggleEnhanced" checked>
            </label>
            <label class="toggle">
                <span>联网搜索</span>
                <input type="checkbox" id="toggleWeb" checked>
            </label>
        </div>

        <div class="sidebar-section">
            <h3>用户信息</h3>
            <div class="field">
                <label for="grade">年级</label>
                <input id="grade" placeholder="例如 2023 级">
            </div>
            <div class="field">
                <label for="college">学院</label>
                <input id="college" placeholder="例如 文学院">
            </div>
            <div class="field">
                <label for="major">专业</label>
                <input id="major" placeholder="例如 汉语言文学">
            </div>
            <button class="btn" id="saveProfileBtn">保存用户信息</button>
        </div>

        <div class="sidebar-section">
            <h3>记忆</h3>
            <div class="memory-list" id="memoryList"></div>
            <div class="field">
                <label for="newMemory">新增记忆</label>
                <input id="newMemory" placeholder="例如 我正在准备教师资格证">
            </div>
            <button class="btn" id="addMemoryBtn">添加记忆</button>
            <button class="btn" id="clearMemoriesBtn">清空记忆</button>
        </div>

        <div class="sidebar-section">
            <h3>API 配置</h3>
            <div class="status-hint" id="statusHint">
                请在项目根目录的 .env 中填写 OPENAI_API_KEY / OPENAI_BASE_URL / MODEL_NAME
            </div>
        </div>
    </aside>

    <main class="main">
        <header class="main-header">
            <button class="btn ghost mobile-only" id="sidebarToggle">菜单</button>
            <div class="header-title">首都师范大学在校生生存助手</div>
            <div class="header-actions">
                <button class="btn ghost" id="clearHistoryBtn">清空对话</button>
            </div>
        </header>

        <section class="chat-area" id="chatArea">
            <div class="messages" id="messages">
                <div class="empty-state" id="emptyState">
                    <h2>现在可以开始提问</h2>
                    <p>我会基于本地知识库与联网搜索回答，并保留过程供你展开查看。</p>
                    <div class="suggestions">
                        <button data-question="如何申请缓考？">如何申请缓考？</button>
                        <button data-question="我想申请奖学金，需要准备什么？">我想申请奖学金，需要准备什么？</button>
                        <button data-question="图书馆可以延长借阅时间吗？">图书馆可以延长借阅时间吗？</button>
                        <button data-question="请帮我写一封请假邮件模板">请帮我写一封请假邮件模板</button>
                    </div>
                </div>
            </div>
        </section>

        <footer class="composer">
            <div class="composer-inner">
                <textarea id="messageInput" placeholder="输入你的问题，Enter 发送，Shift+Enter 换行"></textarea>
                <div class="composer-meta">
                    <span>Enter 发送 / Shift+Enter 换行</span>
                    <span class="status-pill" id="inputStatus">待命</span>
                </div>
            </div>
            <button class="btn primary" id="sendBtn">发送</button>
        </footer>
    </main>
</div>

<div class="overlay" id="overlay"></div>
<div class="toast-container" id="toastContainer"></div>

<script>
        const API_BASE = (() => {
            if (window.location.protocol === 'file:') {
                return 'http://localhost:8080';
            }
            return window.location.origin;
        })();

        function apiUrl(path) {
            const safePath = path.startsWith('/') ? path : `/${path}`;
            return API_BASE + safePath;
        }

        const elements = {
            sidebarToggle: document.getElementById('sidebarToggle'),
            overlay: document.getElementById('overlay'),
            newChatBtn: document.getElementById('newChatBtn'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            toggleEnhanced: document.getElementById('toggleEnhanced'),
            toggleWeb: document.getElementById('toggleWeb'),
            statusHint: document.getElementById('statusHint'),
            messages: document.getElementById('messages'),
            emptyState: document.getElementById('emptyState'),
            chatArea: document.getElementById('chatArea'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            inputStatus: document.getElementById('inputStatus'),
            grade: document.getElementById('grade'),
            college: document.getElementById('college'),
            major: document.getElementById('major'),
            saveProfileBtn: document.getElementById('saveProfileBtn'),
            memoryList: document.getElementById('memoryList'),
            newMemory: document.getElementById('newMemory'),
            addMemoryBtn: document.getElementById('addMemoryBtn'),
            clearMemoriesBtn: document.getElementById('clearMemoriesBtn'),
            toastContainer: document.getElementById('toastContainer')
        };

        const state = {
            isLoading: false
        };

        function showToast(message, type = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 2400);
        }

        function toggleSidebar(open) {
            if (open) {
                document.body.classList.add('sidebar-open');
            } else {
                document.body.classList.remove('sidebar-open');
            }
        }

        function setEmptyState(visible) {
            elements.emptyState.style.display = visible ? 'block' : 'none';
        }

        function scrollToBottom() {
            elements.chatArea.scrollTop = elements.chatArea.scrollHeight;
        }

        function setInputStatus(text, warn = false) {
            elements.inputStatus.textContent = text;
            elements.inputStatus.classList.toggle('warn', warn);
        }

        function setSendState() {
            const hasText = elements.messageInput.value.trim().length > 0;
            elements.sendBtn.disabled = !hasText || state.isLoading;
        }

        function autoResize() {
            const input = elements.messageInput;
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 160) + 'px';
        }

        async function requestJson(url, options = {}) {
            const response = await fetch(url, options);
            let data = null;
            try {
                data = await response.json();
            } catch (err) {
                data = null;
            }
            if (!response.ok) {
                const detail = data && (data.detail || data.error || data.message);
                throw new Error(detail || `HTTP ${response.status}`);
            }
            return data || {};
        }

        function shorten(text, max = 60) {
            if (!text) return '';
            if (text.length <= max) return text;
            return text.slice(0, max) + '...';
        }

        function buildProcessLines(trace) {
            const lines = [];
            if (!trace) return lines;

            if (trace.intent) {
                lines.push(`意图识别: ${trace.intent}`);
            }

            if (trace.decomposition) {
                const subCount = (trace.decomposition.sub_questions || []).length;
                if (trace.decomposition.should_decompose) {
                    lines.push(`任务拆解: ${subCount} 个子问题`);
                } else {
                    lines.push('任务拆解: 未触发');
                }
            }

            if (trace.used_iteration) {
                const rounds = (trace.iterations || []).length;
                lines.push(`迭代检索: ${rounds} 轮`);
            }

            // 回退检索功能已移除，不再显示相关信息

            (trace.retrievals || []).forEach(ret => {
                const docCount = (ret.docs || []).length;
                const duration = Math.round(ret.duration_ms || 0);
                lines.push(`检索(${ret.method}): ${shorten(ret.query, 72)} -> ${docCount} 条 (${duration}ms)`);
            });

            (trace.reranks || []).forEach(rerank => {
                const before = (rerank.before_ranking || []).length;
                const after = (rerank.after_ranking || []).length;
                const duration = Math.round(rerank.duration_ms || 0);
                lines.push(`重排: ${before} -> ${after} (${duration}ms)`);
            });

            if (trace.web_searches && trace.web_searches.length) {
                trace.web_searches.forEach(ws => {
                    const count = (ws.results || []).length;
                    const duration = Math.round(ws.duration_ms || 0);
                    lines.push(`联网搜索: ${shorten(ws.query, 72)} -> ${count} 条 (${duration}ms)`);
                });
            } else if (trace.used_web_search === false) {
                lines.push('联网搜索: 未触发');
            }

            if (trace.total_duration_ms) {
                lines.push(`总耗时: ${Math.round(trace.total_duration_ms)}ms`);
            }

            return lines;
        }

        function createThinkingPanel() {
            const details = document.createElement('details');
            details.className = 'thinking';

            const summary = document.createElement('summary');
            const title = document.createElement('span');
            title.textContent = '思维过程';
            const status = document.createElement('span');
            status.className = 'think-status';
            status.textContent = '生成中';
            summary.append(title, status);

            const placeholder = document.createElement('div');
            placeholder.className = 'think-placeholder';
            ['正在分析问题...', '检索相关资料...', '组织答案结构...'].forEach((text, index) => {
                const line = document.createElement('span');
                line.className = 'think-line';
                line.textContent = text;
                line.style.animationDelay = `${index * 0.25}s`;
                placeholder.appendChild(line);
            });

            const body = document.createElement('div');
            body.className = 'think-body';

            details.append(summary, placeholder, body);

            return { root: details, body, status };
        }

        function renderThinking(thinking, lines, statusText) {
            if (!thinking) return;
            thinking.status.textContent = statusText;
            thinking.body.innerHTML = '';

            if (!lines || !lines.length) {
                const empty = document.createElement('div');
                empty.className = 'think-item think-muted';
                empty.textContent = '暂无过程日志';
                thinking.body.appendChild(empty);
                return;
            }

            lines.forEach((line, index) => {
                const item = document.createElement('div');
                item.className = 'think-item';
                const indexEl = document.createElement('span');
                indexEl.className = 'think-index';
                indexEl.textContent = `${index + 1}.`;
                const textEl = document.createElement('span');
                textEl.textContent = line;
                item.append(indexEl, textEl);
                thinking.body.appendChild(item);
            });
        }

        function setTags(container, tags) {
            container.innerHTML = '';
            if (!tags || !tags.length) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'flex';
            tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = `tag ${tag.type || ''}`;
                span.textContent = tag.label;
                container.appendChild(span);
            });
        }

        function setEvidence(details, local, web) {
            const localCount = local ? local.length : 0;
            const webCount = web ? web.length : 0;

            if (!localCount && !webCount) {
                details.style.display = 'none';
                details.innerHTML = '';
                return;
            }

            details.style.display = 'block';
            details.innerHTML = '';
            const summary = document.createElement('summary');
            summary.textContent = `证据来源：本地 ${localCount} 条，网络 ${webCount} 条`;
            details.appendChild(summary);

            const list = document.createElement('div');
            list.className = 'evidence-list';

            const appendItems = (items, label) => {
                items.forEach(item => {
                    const ev = document.createElement('div');
                    ev.className = 'evidence-item';
                    const source = item.source || label;
                    const contentText = shorten(item.content || '', 160);
                    ev.textContent = `${source}: ${contentText}`;
                    list.appendChild(ev);
                });
            };

            if (localCount) appendItems(local, '本地');
            if (webCount) appendItems(web, '网络');

            details.appendChild(list);
        }

        function setMemories(container, memories) {
            container.innerHTML = '';
            if (!memories || !memories.length) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';
            const title = document.createElement('div');
            title.textContent = '新记忆已保存：';
            const list = document.createElement('ul');
            memories.forEach(mem => {
                const item = document.createElement('li');
                item.textContent = mem;
                list.appendChild(item);
            });
            container.append(title, list);
        }

        function addMessage(role, content, meta = {}) {
            const wrapper = document.createElement('div');
            wrapper.className = `message ${role}`;
            if (meta.pending) {
                wrapper.classList.add('pending');
            }

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = role === 'user' ? '你' : '助';

            const body = document.createElement('div');
            body.className = 'message-body';

            const header = document.createElement('div');
            header.className = 'message-header';
            const name = document.createElement('span');
            name.textContent = role === 'user' ? '你' : 'CNU 助手';
            const time = document.createElement('span');
            time.textContent = meta.timestamp || new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            header.append(name, time);

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.textContent = content || '';

            const tags = document.createElement('div');
            tags.className = 'tags';

            const evidence = document.createElement('details');
            evidence.className = 'evidence';

            const memory = document.createElement('div');
            memory.className = 'memory-note';

            let thinking = null;
            if (role === 'assistant' && !meta.hideThinking) {
                thinking = createThinkingPanel();
            }

            body.append(header, bubble, tags, evidence, memory);
            if (thinking) {
                body.appendChild(thinking.root);
            }
            wrapper.append(avatar, body);
            elements.messages.appendChild(wrapper);
            scrollToBottom();

            setTags(tags, meta.tags || []);
            setEvidence(evidence, meta.evidence_local || [], meta.evidence_web || []);
            setMemories(memory, meta.new_memories || []);

            return { wrapper, bubble, thinking, tags, evidence, memory };
        }

        async function loadTrace(traceId, thinking) {
            if (!thinking || !traceId) return;
            try {
                const trace = await requestJson(apiUrl(`/api/logs/${traceId}`));
                const lines = buildProcessLines(trace);
                renderThinking(thinking, lines, '已完成');
            } catch (err) {
                renderThinking(thinking, ['过程日志加载失败。'], '加载失败');
            }
        }

        async function sendMessage() {
            if (state.isLoading) return;
            const question = elements.messageInput.value.trim();
            if (!question) return;

            setEmptyState(false);
            addMessage('user', question);
            elements.messageInput.value = '';
            autoResize();
            setSendState();

            state.isLoading = true;
            setInputStatus('思考中', false);

            const assistant = addMessage('assistant', '正在思考...', { pending: true });

            try {
                const payload = {
                    question,
                    enable_web_search: elements.toggleWeb.checked,
                    use_enhanced: elements.toggleEnhanced.checked
                };

                const result = await requestJson(apiUrl('/api/chat'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                assistant.wrapper.classList.remove('pending');
                assistant.bubble.textContent = result.answer || '未返回内容';

                const tags = [];
                if (result.intent) tags.push({ label: `意图: ${result.intent}`, type: 'intent' });
                if (result.used_web_search) tags.push({ label: '联网搜索' });
                if (result.used_iteration) tags.push({ label: '迭代检索' });
                // 回退检索功能已移除，不再显示标签
                if (result.total_duration_ms) tags.push({ label: `耗时 ${Math.round(result.total_duration_ms)}ms` });
                if (result.trace_id) tags.push({ label: `Trace ${result.trace_id}` });

                setTags(assistant.tags, tags);
                setEvidence(assistant.evidence, result.evidence_local || [], result.evidence_web || []);
                setMemories(assistant.memory, result.new_memories || []);

                if (result.new_memories && result.new_memories.length) {
                    loadMemories();
                }

                if (assistant.thinking) {
                    if (result.trace_id) {
                        await loadTrace(result.trace_id, assistant.thinking);
                    } else {
                        renderThinking(assistant.thinking, ['未返回 Trace ID，无法加载过程日志。'], '无日志');
                    }
                }
            } catch (err) {
                assistant.wrapper.classList.remove('pending');
                assistant.bubble.textContent = `请求失败: ${err.message}`;
                if (assistant.thinking) {
                    renderThinking(assistant.thinking, ['请求失败，未能生成过程。'], '失败');
                }
                showToast(`发送失败: ${err.message}`, 'error');
            } finally {
                state.isLoading = false;
                setSendState();
                setInputStatus('待命', false);
                scrollToBottom();
            }
        }

        async function loadHistory() {
            try {
                const data = await requestJson(apiUrl('/api/history'));
                const history = data.history || [];
                elements.messages.querySelectorAll('.message').forEach(item => item.remove());

                if (history.length) {
                    setEmptyState(false);
                    history.forEach(item => {
                        addMessage(item.role, item.content, {
                            timestamp: item.timestamp,
                            tags: item.intent ? [{ label: `意图: ${item.intent}`, type: 'intent' }] : [],
                            hideThinking: true
                        });
                    });
                } else {
                    setEmptyState(true);
                }
            } catch (err) {
                setEmptyState(true);
                showToast('历史记录加载失败', 'error');
            }
        }

        async function clearHistory() {
            if (!confirm('确认清空所有对话记录吗？')) return;
            try {
                await requestJson(apiUrl('/api/history'), { method: 'DELETE' });
                elements.messages.querySelectorAll('.message').forEach(item => item.remove());
                setEmptyState(true);
                showToast('对话已清空');
            } catch (err) {
                showToast(`清空失败: ${err.message}`, 'error');
            }
        }

        async function loadProfile() {
            try {
                const data = await requestJson(apiUrl('/api/profile'));
                elements.grade.value = data.grade || '';
                elements.college.value = data.college || '';
                elements.major.value = data.major || '';
            } catch (err) {
                showToast('用户信息加载失败', 'error');
            }
        }

        async function saveProfile() {
            try {
                const payload = {
                    grade: elements.grade.value.trim(),
                    college: elements.college.value.trim(),
                    major: elements.major.value.trim()
                };
                const result = await requestJson(apiUrl('/api/profile'), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (result.success) {
                    showToast('用户信息已保存');
                }
            } catch (err) {
                showToast(`保存失败: ${err.message}`, 'error');
            }
        }

        function renderMemories(list) {
            elements.memoryList.innerHTML = '';
            if (!list || !list.length) {
                const empty = document.createElement('div');
                empty.className = 'status-hint';
                empty.textContent = '暂无记忆';
                elements.memoryList.appendChild(empty);
                return;
            }

            list.forEach(mem => {
                const item = document.createElement('div');
                item.className = 'memory-item';

                const content = document.createElement('div');
                content.textContent = mem.content || '';

                const meta = document.createElement('div');
                meta.className = 'memory-meta';
                meta.textContent = mem.created_at || '';

                const actions = document.createElement('div');
                actions.className = 'memory-actions';
                const delBtn = document.createElement('button');
                delBtn.className = 'icon-btn danger';
                delBtn.textContent = '删除';
                delBtn.addEventListener('click', () => deleteMemory(mem.index));

                content.appendChild(meta);
                actions.appendChild(delBtn);
                item.append(content, actions);
                elements.memoryList.appendChild(item);
            });
        }

        async function loadMemories() {
            try {
                const data = await requestJson(apiUrl('/api/memories'));
                renderMemories(data.memories || []);
            } catch (err) {
                showToast('记忆加载失败', 'error');
            }
        }

        async function addMemory() {
            const content = elements.newMemory.value.trim();
            if (!content) return;
            try {
                const result = await requestJson(apiUrl('/api/memories'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (result.success) {
                    elements.newMemory.value = '';
                    loadMemories();
                    showToast('记忆已添加');
                } else {
                    showToast(result.message || '记忆添加失败', 'error');
                }
            } catch (err) {
                showToast(`记忆添加失败: ${err.message}`, 'error');
            }
        }

        async function deleteMemory(index) {
            try {
                await requestJson(apiUrl(`/api/memories/${index}`), { method: 'DELETE' });
                loadMemories();
            } catch (err) {
                showToast(`删除失败: ${err.message}`, 'error');
            }
        }

        async function clearMemories() {
            if (!confirm('确认清空所有记忆吗？')) return;
            try {
                await requestJson(apiUrl('/api/memories'), { method: 'DELETE' });
                loadMemories();
                showToast('记忆已清空');
            } catch (err) {
                showToast(`清空失败: ${err.message}`, 'error');
            }
        }

        async function loadApiStatus() {
            try {
                const data = await requestJson(apiUrl('/api/config'));
                if (data.api_key_set && data.base_url && data.model_name) {
                    elements.statusHint.textContent = 'API 已配置（修改请编辑 .env）';
                    setInputStatus('待命', false);
                } else {
                    elements.statusHint.textContent = 'API 未完整，请在 .env 中配置 OPENAI_API_KEY / OPENAI_BASE_URL / MODEL_NAME';
                    setInputStatus('API 未完整', true);
                }
            } catch (err) {
                elements.statusHint.textContent = 'API 状态加载失败，请在 .env 中配置 OPENAI_API_KEY / OPENAI_BASE_URL / MODEL_NAME';
                setInputStatus('API 加载失败', true);
                showToast('API 配置加载失败', 'error');
            }
        }

        function bindEvents() {
            elements.sidebarToggle.addEventListener('click', () => toggleSidebar(true));
            elements.overlay.addEventListener('click', () => toggleSidebar(false));

            elements.newChatBtn.addEventListener('click', clearHistory);
            elements.clearHistoryBtn.addEventListener('click', clearHistory);
            elements.saveProfileBtn.addEventListener('click', saveProfile);
            elements.addMemoryBtn.addEventListener('click', addMemory);
            elements.clearMemoriesBtn.addEventListener('click', clearMemories);

            elements.messageInput.addEventListener('input', () => {
                autoResize();
                setSendState();
            });

            elements.messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });

            elements.sendBtn.addEventListener('click', sendMessage);

            elements.newMemory.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    addMemory();
                }
            });

            document.querySelectorAll('[data-question]').forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.messageInput.value = btn.dataset.question || '';
                    autoResize();
                    setSendState();
                    sendMessage();
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            bindEvents();
            setSendState();
            autoResize();
            loadHistory();
            loadProfile();
            loadMemories();
            loadApiStatus();
        });
    </script>
</body>
</html>
